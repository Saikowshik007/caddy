jobtrackai.duckdns.org {
    # Automatic HTTPS with Let's Encrypt

    # Handle OPTIONS preflight globally
    @options method OPTIONS
    handle @options {
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD"
        header Access-Control-Allow-Headers "*"
        header Access-Control-Allow-Credentials "true"
        header Access-Control-Max-Age "3600"
        respond 204
    }

    # Learning Platform endpoints - KEEP /learn prefix (Flask expects it!)
    handle /learn/* {
        # Add CORS headers
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD"
        header Access-Control-Allow-Headers "*"
        header Access-Control-Allow-Credentials "true"
        header Access-Control-Expose-Headers "*"

        # Forward to learning backend WITH /learn prefix
        reverse_proxy learning-platform-backend:5000
    }

    # JobTrak API endpoints (microservice 2)
    handle /api/* {
        # Add CORS headers
        header Access-Control-Allow-Origin "*"
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH, HEAD"
        header Access-Control-Allow-Headers "*"
        header Access-Control-Allow-Credentials "true"
        header Access-Control-Expose-Headers "*"

        # Load balance across 3 API instances
        reverse_proxy jobtrak-api-1:8000 jobtrak-api-2:8000 jobtrak-api-3:8000
    }

    # Root endpoint
    handle / {
        header Access-Control-Allow-Origin "*"
        respond "JobTrak Services Running" 200
    }

    # Health check endpoint
    handle /health {
        header Access-Control-Allow-Origin "*"
        reverse_proxy jobtrak-api-1:8000
    }
}